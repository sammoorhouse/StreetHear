<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Street Hear</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #pano {
      width: 100%;
      height: 100%;
    }

    .wrap {
      position: relative;
    }
  </style>
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,900' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="js/jquery.big-slide.js"></script>
</head>

<body>
  <nav id="menu" class="panel" role="navigation" style="position: fixed; top: 0px; bottom: 0px; height: 100%; left: -15.625em; width: 15.625em; transition: left 300ms ease;">
    <img src="img/sam-moorhouse.png" width="100" />

    <p>An audio map, because I &#9829; NYC</p>
    <ul>
      <li>
        <a href="https://github.com/sammoorhouse/StreetHear">
          <span class="icon-github nav-icon"></span>Github</a>
      </li>
    </ul>
  </nav>
  <div id="pano" class="push">
    <a href="#menu" class="menu-link">&#9776;</a>
  </div>
  <script>
    var audios = [{
      "marker": "48th & 7th",
      "lat": 40.7598383,
      "lng": -73.9863735,
      "recorder": "Sam Moorhouse",
      "filename": "20160407 163345.m4a"
    }, {
      "marker": "49th & 7th",
      "lat": 40.7604606,
      "lng": -73.9859169,
      "recorder": "Sam Moorhouse",
      "filename": "20160407 163051.m4a"
    }, {
      "marker": "36th & 6th",
      "lat": 40.7510879,
      "lng": -73.989044,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 184813.m4a"
    }, {
      "marker": "36th & Broadway",
      "lat": 40.7514509,
      "lng": -73.989901,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 185102.m4a"
    }, {
      "marker": "37th & Broadway",
      "lat": 40.7521813,
      "lng": -73.9897307,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 185352.m4a"
    }, {
      "marker": "38th & Broadway",
      "lat": 40.7529148,
      "lng": -73.9895457,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 185706.m4a"
    }, {
      "marker": "750 7th Ave",
      "lat": 40.761194,
      "lng": -73.9859775,
      "recorder": "Sam Moorhouse",
      "filename": "20160407 162814.m4a"
    }, ]

    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioCtx = new AudioContext();

    $(document).ready(function() {
      $('.menu-link').bigSlide({
        "easyClose": true
      });
    });

    function loadAudio(filename, lat, lng) {

      var loader = new XMLHttpRequest()
      loader.open("GET", "audio/" + filename)
      loader.responseType = "arraybuffer"
      loader.onload = whenLoaded
      loader.send()

      function whenLoaded(event) {
        var data = loader.response

        if (data === null) {
          // There was a problem loading the file.
          console.log("There was a problem loading the file.")
          return
        }
        audioCtx.decodeAudioData(data, whenDecoded)
      }

      function whenDecoded(audioBuffer) {
        console.log("play")
        play(audioBuffer, lat, lng, 0, audioCtx)
      }
    }

    function play(audioBuffer, x, y, z, audioContext) {
      var source = audioContext.createBufferSource()
      source.buffer = audioBuffer
      source.loop = true

      var panner = audioContext.createPanner()
      panner.panningModel = "HRTF"
      panner.refDistance = 0.00001
      panner.maxDistance = 0.01
      panner.rolloffFactor = 0.1;
      panner.setPosition(x, y, z)

      source.connect(panner)
      panner.connect(audioContext.destination)

      source.start()
    }

    audios.forEach(function(audio) {
      loadAudio(audio.filename, audio.lat, audio.lng)
    })


    function initPano() {
      var panorama = new google.maps.StreetViewPanorama(
        document.getElementById('pano'), {
          position: {
            lat: 40.7598567,
            lng: -73.9841719
          },
          pov: {
            heading: 270,
            pitch: 0
          },
          visible: true,
          linksControl: false,
          panControl: false,
          zoomControl: false,
          addressControl: false,
          enableCloseButton: false,
          fullscreenControl: false

        });

      panorama.addListener('position_changed', function() {
        var pos = panorama.getPosition();
        audioCtx.listener.setPosition(pos.lat(), pos.lng(), 0)
      });

      panorama.addListener('pov_changed', function() {
        var heading = panorama.getPov().heading * Math.PI / 180
        audioCtx.listener.setOrientation(Math.cos(heading), 0, Math.sin(heading), 0, 1, 0)
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt5UF9EqFa26jDnHC7u3bzoR7NjaxAhwE&callback=initPano" async defer>
  </script>
</body>

</html>
