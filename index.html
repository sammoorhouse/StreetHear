<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Street Hear</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #pano {
      width: 100%;
      height: 100%;
    }

    .wrap {
      position: relative;
    }
  </style>
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,900' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="js/jquery.big-slide.js"></script>
</head>

<body>
  <nav id="menu" class="panel" role="navigation" style="position: fixed; top: 0px; bottom: 0px; height: 100%; left: -15.625em; width: 15.625em; transition: left 300ms ease;">
    <img src="img/sam-moorhouse.png" width="100" />

    <p>An audio map, because I &#9829; NYC</p>
    <p>Localised sounds fade in and out as you move around the city.</p>
    <ul>
      <li>
        <a href="#" class="timessq">
          <span class="nav-icon fa fa-map-marker"></span>Times Sq
        </a>
      </li>
      <li>
        <a href="#" class="36-6">
          <span class="nav-icon fa fa-map-marker"></span>36th &amp; 6th
        </a>
      </li>
      <li>
        <a href="#" class="36-b">
          <span class="nav-icon fa fa-map-marker"></span>36th &amp; Broadway
        </a>
      </li>
      <li>
        <a href="https://github.com/sammoorhouse/StreetHear">
          <span class="icon-github nav-icon"></span>Github</a>
      </li>
      <li>
        <a href="#" class="mute">
          <span id="mute-icon" class="nav-icon fa fa-volume-off"></span>
          <span id="mute-text">Mute</span>
        </a>
      </li>
    </ul>
  </nav>
  <div id="pano" class="push">
    <a href="#menu" class="menu-link">&#9776;</a>
  </div>
  <script>
    var audios = [{
      "marker": "48th & 7th",
      "lat": 40.7598383,
      "lng": -73.9863735,
      "recorder": "Sam Moorhouse",
      "filename": "20160407 163345.m4a"
    }, {
      "marker": "49th & 7th",
      "lat": 40.7604606,
      "lng": -73.9859169,
      "recorder": "Sam Moorhouse",
      "filename": "20160407 163051.m4a"
    }, {
      "marker": "36th & 6th",
      "lat": 40.7510879,
      "lng": -73.989044,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 184813.m4a"
    }, {
      "marker": "36th & Broadway",
      "lat": 40.7514509,
      "lng": -73.9898957,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 185102.m4a"
    }, {
      "marker": "37th & Broadway",
      "lat": 40.7521813,
      "lng": -73.9897307,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 185352.m4a"
    }, {
      "marker": "38th & Broadway",
      "lat": 40.7529148,
      "lng": -73.9895457,
      "recorder": "Sam Moorhouse",
      "filename": "20160409 185706.m4a"
    }, {
      "marker": "750 7th Ave",
      "lat": 40.761194,
      "lng": -73.9859775,
      "recorder": "Sam Moorhouse",
      "filename": "20160407 162814.m4a"
    }, ]

    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioCtx = new AudioContext()
    var gainNode = audioCtx.createGain()
    gainNode.connect(audioCtx.destination)

    $(document).ready(function() {
      $('.menu-link').bigSlide({
        "easyClose": true
      });
    });

    var mute = document.querySelector('.mute');
    var muteicon = document.querySelector('#mute-icon');
    var mutetext = document.querySelector('#mute-text');
    mute.onclick = function() { // toggle to mute and unmute sound
      if (mute.id == "") {
        gainNode.gain.value = 0; // gain set to 0 to mute sound
        mute.id = "activated";
        muteicon.className = "nav-icon fa fa-volume-up"
        mutetext.innerHTML = "Unmute";
      } else {
        gainNode.gain.value = 1; // gain set to 1 to unmute sound
        mute.id = "";
        muteicon.className = "nav-icon fa fa-volume-off"
        mutetext.innerHTML = "Mute";
      }
    }

    function loadAudio(filename, lat, lng) {

      var loader = new XMLHttpRequest()
      loader.open("GET", "audio/" + filename)
      loader.responseType = "arraybuffer"
      loader.onload = whenLoaded
      loader.send()

      function whenLoaded(event) {
        var data = loader.response

        if (data === null) {
          // There was a problem loading the file.
          console.log("There was a problem loading the file.")
          return
        }
        audioCtx.decodeAudioData(data, whenDecoded)
      }

      function whenDecoded(audioBuffer) {
        console.log("play")
        play(audioBuffer, lat, lng, 0, audioCtx)
      }
    }

    function play(audioBuffer, x, y, z, audioContext) {
      var source = audioContext.createBufferSource()
      source.buffer = audioBuffer
      source.loop = true

      var panner = audioContext.createPanner()
      panner.panningModel = "HRTF"
        //refDistance / (refDistance + rolloffFactor * (distance - refDistance))
      panner.refDistance = 0.00001
      panner.rolloffFactor = 0.05
      panner.setPosition(x, y, z)

      source.connect(panner)
      panner.connect(gainNode)

      source.start()
    }

    audios.forEach(function(audio) {
      loadAudio(audio.filename, audio.lat, audio.lng)
    })


    function initPano() {
      var panorama = new google.maps.StreetViewPanorama(
        document.getElementById('pano'), {
          position: {
            lat: 40.7598567,
            lng: -73.9841719
          },
          pov: {
            heading: 270,
            pitch: 0
          },
          visible: true,
          linksControl: false,
          panControl: false,
          zoomControl: false,
          addressControl: false,
          enableCloseButton: false,
          fullscreenControl: false

        });

      $(".timessq").click(function() {
        panorama.setPosition({
          "lat": 40.7598567,
          "lng": -73.9841719
        })
      });

      $(".36-b").click(function() {
        panorama.setPosition({
          "lat": 40.7514509,
          "lng": -73.9898957,
        })
      });

      $(".36-6").click(function() {
        panorama.setPosition({
          "lat": 40.7510879,
          "lng": -73.989044,
        })
      });

      panorama.addListener('position_changed', function() {
        var pos = panorama.getPosition();
        var lat = pos.lat()
        var lng = pos.lng()
        audioCtx.listener.setPosition(lat, lng, 0)
      });

      panorama.addListener('pov_changed', function() {
        var heading = panorama.getPov().heading * Math.PI / 180
        audioCtx.listener.setOrientation(Math.cos(heading), 0, Math.sin(heading), 0, 1, 0)
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt5UF9EqFa26jDnHC7u3bzoR7NjaxAhwE&callback=initPano" async defer>
  </script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76204437-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

</html>
