<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Street Hear</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #pano {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="pano"></div>
  <script>
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioCtx = new AudioContext();

    var loader = new XMLHttpRequest()

    loader.open("GET", "audio/20160407 162814.m4a")
    loader.responseType = "arraybuffer"
    loader.onload = whenLoaded
    loader.send()

    function whenLoaded(event) {
      var data = loader.response

      if (data === null) {
        // There was a problem loading the file.
        console.log("There was a problem loading the file.")
        return
      }

      // Decode the data.
      audioCtx.decodeAudioData(data, whenDecoded)
    }

    function play(audioBuffer, x, y, z, audioContext) {
      var source = audioContext.createBufferSource()
      source.buffer = audioBuffer
      source.loop = true

      var panner = audioContext.createPanner()
      panner.panningModel = "HRTF"
      panner.refDistance = 0.00001
      panner.maxDistance = 0.01
      panner.rolloffFactor = 0.1;
      panner.setPosition(x, y, z)

      source.connect(panner)
      panner.connect(audioContext.destination)

      source.start()
    }

    function whenDecoded(audioBuffer) {
      play(audioBuffer, 40.7598567, -73.9841719, 0, audioCtx)
    }

    function initPano() {
      var panorama = new google.maps.StreetViewPanorama(
        document.getElementById('pano'), {
          position: {
            lat: 40.7598567,
            lng: -73.9841719
          },
          pov: {
            heading: 270,
            pitch: 0
          },
          visible: true,
          linksControl: false,
          panControl: false,
          zoomControl: false,
          addressControl: false,
          enableCloseButton: false,
          fullscreenControl: false

        });

      panorama.addListener('position_changed', function() {
        var pos = panorama.getPosition();
        console.log(pos.lat() + " " + pos.lng())
        audioCtx.listener.setPosition(pos.lat(), pos.lng(), 0)
      });

      panorama.addListener('pov_changed', function() {
        var heading = panorama.getPov().heading * Math.PI / 180
        audioCtx.listener.setOrientation(Math.cos(heading), 0, Math.sin(heading), 0, 1, 0)
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt5UF9EqFa26jDnHC7u3bzoR7NjaxAhwE&callback=initPano" async defer>
  </script>
</body>

</html>
